name: Enforce PR Title and Labels

on:
  pull_request:
    branches: [ main ]
    types: [opened, reopened, synchronize]

jobs:
  enforce-pr-title:
    name: Enforce PR title to respect Gitmoji
    runs-on: ubuntu-latest
    steps:
      - name: check PR title respects Gitmoji
        run: |
          if echo "${{ github.event.pull_request.title }}" | grep -E '^(ğŸ¨|âš¡ï¸|ğŸ”¥|ğŸ›|ğŸš‘ï¸|ğŸš‘|âœ¨|ğŸ“|ğŸš€|ğŸ’„|ğŸ‰|âœ…|ğŸ”’ï¸|ğŸ”’|ğŸ”|ğŸ”–|ğŸš¨|ğŸš§|ğŸ’š|â¬‡ï¸|â¬†ï¸|ğŸ“Œ|ğŸ‘·|ğŸ‘·â€â™‚ï¸|ğŸ“ˆ|â™»ï¸|â•|â–|ğŸ”§|ğŸ”¨|ğŸŒ|âœï¸|ğŸ’©|âªï¸|âª|ğŸ”€|ğŸ“¦ï¸|ğŸ“¦|ğŸ‘½ï¸|ğŸ‘½|ğŸšš|ğŸ“„|ğŸ’¥|ğŸ±|â™¿ï¸|â™¿|ğŸ’¡|ğŸ»|ğŸ’¬|ğŸ—ƒï¸|ğŸ”Š|ğŸ”‡|ğŸ‘¥|ğŸ‘¥|ğŸš¸|ğŸ—ï¸|ğŸ“±|ğŸ¤¡|ğŸ¥š|ğŸ™ˆ|ğŸ“¸|âš—ï¸|ğŸ”ï¸|ğŸ”|ğŸ·ï¸|ğŸŒ±|ğŸš©|ğŸ¥…|ğŸ’«|ğŸ—‘ï¸|ğŸ›‚|ğŸ©¹|ğŸ§|âš°ï¸|ğŸ§ª|ğŸ‘”|ğŸ©º|ğŸ§±|ğŸ§‘â€ğŸ’»|ğŸ‘¨â€ğŸ’»|ğŸ’¸|ğŸ§µ|ğŸ¦º) '; then
            exit 0
          else
            exit 1
          fi
  autolabel-pr:
    name: Autolabel PR by basing on branch name
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: TimonVS/pr-labeler-action@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
  enforce-pr-labels:
    name: Enforce PR labels `type.*` and `breaking-change`
    runs-on: ubuntu-latest
    needs: autolabel-pr
    if: always() && (contains(fromJson('["success","skipped"]'), needs.autolabel-pr.result))
    steps:
      - uses: yogevbd/enforce-label-action@2.2.2
        with:
          REQUIRED_LABELS_ANY: "type.feat,type.fix,type.chore,type.test,type.docs,type.devops"
      - uses: yogevbd/enforce-label-action@2.2.2
        with:
          REQUIRED_LABELS_ANY: "breaking-change,non-breaking-change"
